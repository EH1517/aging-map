<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>State-Level School Closure Risk Map</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg-header: #16213e;
    --text-primary: #e0e0e0;
    --text-dark: #2c2c2c;
    --accent: #e94560;
    --accent-light: #ff6b81;
    --shadow: 0 2px 8px rgba(0,0,0,0.15);
    --green: #2d9a2d;
    --yellow: #d4a017;
    --orange: #e67e22;
    --red: #c0392b;
  }
  html, body {
    height: 100%;
    font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f0f0f0;
    color: var(--text-dark);
  }
  .header {
    background: var(--bg-header);
    color: var(--text-primary);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
  }
  .header h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; }
  .header .subtitle { font-size: 12px; font-weight: 300; opacity: 0.7; }
  .header nav { display: flex; gap: 16px; }
  .header nav a { color: var(--accent-light); text-decoration: none; font-size: 12px; font-weight: 500; }
  .header nav a:hover { text-decoration: underline; }

  .stats-banner {
    background: #fff;
    border-bottom: 1px solid #ddd;
    padding: 10px 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 36px;
    flex-wrap: wrap;
    box-shadow: var(--shadow);
  }
  .stat-card { text-align: center; }
  .stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.7px; color: #888; margin-bottom: 2px; }
  .stat-value { font-size: 24px; font-weight: 700; line-height: 1.1; }
  .stat-sub { font-size: 11px; color: #888; }
  .stat-value.decline { color: var(--red); }
  .stat-value.closures { color: var(--orange); }
  .stat-value.students { color: var(--accent); }

  .stats-context {
    background: #fafaf7;
    border-bottom: 1px solid #e8e4d8;
    padding: 5px 24px;
    font-size: 11px;
    color: #777;
    text-align: center;
    font-style: italic;
    line-height: 1.5;
  }
  .stats-context a { color: #888; text-decoration: underline; }
  .stats-context strong { color: #555; font-style: normal; }

  .map-container { height: calc(100vh - 250px); min-height: 400px; position: relative; }
  #map { height: 100%; width: 100%; }

  .controls {
    background: #fff;
    border-top: 1px solid #ddd;
    padding: 10px 24px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.06);
  }
  .control-group { display: flex; align-items: center; gap: 6px; }
  .control-group label { font-size: 11px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }

  .slider-container { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 200px; max-width: 340px; }
  .year-slider { flex: 1; -webkit-appearance: none; appearance: none; height: 5px; background: #ddd; border-radius: 3px; outline: none; }
  .year-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; }
  .year-slider::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; border: none; }
  .year-display { font-size: 18px; font-weight: 700; color: var(--accent); min-width: 40px; text-align: center; }

  select.ctrl-select { padding: 5px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; font-family: inherit; background: #fff; }

  .toggle-group { display: flex; gap: 0; }
  .toggle-group input[type="radio"] { display: none; }
  .toggle-group label.tbtn { padding: 5px 12px; background: #eee; border: 1px solid #ccc; font-size: 11px; font-weight: 600; cursor: pointer; color: #555; }
  .toggle-group label.tbtn:first-of-type { border-radius: 5px 0 0 5px; }
  .toggle-group label.tbtn:last-of-type { border-radius: 0 5px 5px 0; }
  .toggle-group input:checked + label.tbtn { background: var(--accent); color: #fff; border-color: var(--accent); }

  .legend {
    position: absolute; bottom: 20px; right: 10px; z-index: 800;
    background: rgba(255,255,255,0.93); padding: 10px 12px; border-radius: 8px;
    box-shadow: var(--shadow); font-size: 11px;
  }
  .legend-title { font-weight: 600; margin-bottom: 4px; font-size: 12px; }
  .legend-item { display: flex; align-items: center; gap: 5px; margin: 2px 0; }
  .legend-color { width: 18px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.12); }

  .state-tooltip {
    background: rgba(22,33,62,0.9) !important; color: #fff !important;
    border: none !important; border-radius: 6px !important;
    padding: 5px 10px !important; font-family: 'IBM Plex Sans', sans-serif !important;
    font-size: 12px !important; box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
  }

  .leaflet-popup-content {
    font-family: 'IBM Plex Sans', sans-serif; font-size: 12px; line-height: 1.5; min-width: 280px;
  }
  .popup-title { font-size: 14px; font-weight: 700; margin-bottom: 6px; }
  .popup-stat { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #f0f0f0; }
  .popup-stat .plbl { color: #666; }
  .popup-stat .pval { font-weight: 600; }
  .popup-trend { margin-top: 8px; }
  .popup-trend table { width: 100%; border-collapse: collapse; font-size: 10px; }
  .popup-trend th { font-weight: 600; text-align: center; padding: 2px 3px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
  .popup-trend td { text-align: center; padding: 2px 3px; }
  .popup-trend .cur { background: #fff3cd; font-weight: 600; }

  .methodology-toggle {
    display: block; width: 100%; padding: 8px 24px; background: #f5f5f5;
    border: none; border-top: 1px solid #ddd; font-family: inherit;
    font-size: 12px; font-weight: 600; color: #666; cursor: pointer; text-align: left;
  }
  .methodology-toggle:hover { background: #eee; }
  .methodology { background: #fff; border-top: 1px solid #ddd; max-height: 0; overflow: hidden; transition: max-height 0.5s ease; }
  .methodology.open { max-height: 4000px; overflow-y: auto; }
  .meth-content { padding: 16px 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 12px; line-height: 1.6; color: #444; }
  .meth-content h3 { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .meth-content .full { grid-column: 1 / -1; }
  .meth-content a { color: var(--accent); }

  .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s; }
  .loading.hidden { opacity: 0; pointer-events: none; }
  .loading-spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { margin-top: 12px; font-size: 14px; color: #666; }

  @media (max-width: 900px) {
    .controls { gap: 10px; }
    .meth-content { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading state projection data...</div>
</div>

<div class="header">
  <div>
    <h1>State-Level School Closure Risk Map</h1>
    <div class="subtitle">Projected enrollment decline from fertility trends, 2025&ndash;2040</div>
  </div>
  <nav>
    <a href="index.html">County Aging Maps</a>
    <a href="national.html">National Projections</a>
  </nav>
</div>

<div class="stats-banner">
  <div class="stat-card">
    <div class="stat-label">Scenario</div>
    <div class="stat-value" id="statScenario" style="font-size:14px;color:#555">&mdash;</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Avg Enrollment Decline</div>
    <div class="stat-value decline" id="statDecline">&mdash;</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Expected Closures (Cumulative)</div>
    <div class="stat-value closures" id="statClosures">&mdash;</div>
    <div class="stat-sub" id="statClosuresSub">nationally</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Students Affected</div>
    <div class="stat-value students" id="statStudents">&mdash;</div>
  </div>
</div>

<div class="stats-context">
  <strong>External benchmark:</strong> Brookings Institution (2024) projects <strong>2.9M&ndash;8.5M fewer</strong> traditional public school students nationally by 2050 &mdash; the lower end assumes COVID-era enrollment shifts from public schools to private schools/homeschooling were temporary; the upper end assumes they persist. These maps reflect demographic factors only and represent the lower bound of that range. &nbsp;<a href="https://www.brookings.edu/articles/declining-public-school-enrollment/" target="_blank">Source</a>
</div>

<div class="map-container">
  <div id="map"></div>
  <div class="legend" id="legend"></div>
</div>

<div class="controls">
  <div class="control-group slider-container">
    <label>Year</label>
    <input type="range" class="year-slider" id="yearSlider" min="0" max="6" step="1" value="2">
    <span class="year-display" id="yearDisplay">2030</span>
  </div>

  <div class="control-group">
    <label>Scenario</label>
    <div class="toggle-group">
      <input type="radio" name="scenario" id="scenTrend" value="state_trend" checked>
      <label class="tbtn" for="scenTrend">State Fertility Trend</label>
      <input type="radio" name="scenario" id="scenEnroll" value="enrollment_proj">
      <label class="tbtn" for="scenEnroll">NCES / State Gvm't</label>
    </div>
  </div>

  <div class="control-group">
    <label>Color by</label>
    <select class="ctrl-select" id="colorMetric">
      <option value="enrollment_decline_pct">Enrollment Decline %</option>
      <option value="expected_closures">Expected Closures</option>
      <option value="expected_closures_pct">Closure Risk %</option>
      <option value="fertility_rate">Fertility Rate</option>
    </select>
  </div>
</div>

<button class="methodology-toggle" id="methToggle">Methodology &amp; Sources &#9660;</button>
<div class="methodology" id="methodology">
  <div class="meth-content">
    <div class="full">
      <h3>Reading the Map</h3>
      <p>Use the <strong>Color by</strong> dropdown to switch between four views of the data:</p>
      <p>&bull; <strong>Enrollment Decline %</strong> &mdash; The projected percentage change in K&ndash;12 enrollment relative to 2022. For the State Fertility Trend scenario, this reflects births entering the school pipeline; for NCES / State Gvm't, it reflects official enrollment projections. On the NCES / State Gvm't tab this metric uses a diverging color scale: green = projected enrollment <em>growth</em>, red = projected decline.</p>
      <p>&bull; <strong>Expected Closures</strong> &mdash; The estimated number of traditional public schools likely to close by the selected year, based on how projected enrollment decline interacts with each state's existing school-size distribution. States with many small rural schools show higher counts even at moderate decline rates. States projected to gain enrollment show zero expected closures, since population growth implies net school openings rather than closures.</p>
      <p>&bull; <strong>Closure Risk %</strong> &mdash; Expected closures as a share of each state's total school count. Normalizes for state size to reveal which states face the highest <em>proportion</em> of schools at risk.</p>
      <p>&bull; <strong>Fertility Rate</strong> &mdash; The projected general fertility rate (births per 1,000 women ages 15&ndash;44). Only available for the State Fertility Trend scenario, which is built directly from fertility trajectories. Lower rates (darker red) indicate states where the birth decline is most severe.</p>
    </div>
    <div>
      <h3>Scenario Descriptions</h3>
      <p><strong>State Fertility Trend:</strong> Extrapolates each state's own 2005&ndash;2022 fertility decline rate forward, with a floor of 35 births per 1,000 women 15&ndash;44. States with steep recent declines (e.g., Utah, Idaho) see sharper projected enrollment falls. Enrollment is derived via the pipeline lag model (see below).</p>
      <p><strong>NCES / State Gvm't:</strong> Bypasses the fertility model entirely and uses published enrollment projections directly. The base source is the NCES state-level enrollment forecast (all 50 states + DC, projected to 2050). Where state education agencies or planning offices have published more recent or detailed projections, those override the NCES figures: California (CA DOF), Colorado (CO DOLA county-level age data), Iowa (IA DOE), Maryland (MD Dept of Planning), North Carolina, Florida, Texas, Virginia, and Wisconsin. Projections ending before 2040 are linearly extrapolated; an asterisk (*) in the popup trend table marks extrapolated years. This scenario incorporates migration, demographic composition, and local modeling decisions&mdash;not just fertility.</p>
    </div>
    <div>
      <h3>Pipeline Lag Model</h3>
      <p>Applies to the <strong>State Fertility Trend</strong> scenario only. K&ndash;12 enrollment in year Y draws on 13 birth cohorts: children born in years Y&minus;17 (entering 12th grade) through Y&minus;5 (entering kindergarten). Only cohorts born after 2022 carry the projected fertility decline; earlier cohorts are already in the pipeline at their historical size.</p>
      <p>The share of the pipeline affected by post-2022 fertility trends therefore grows over time: 0 of 13 cohorts are post-2022 as of 2027 (meaning no effect yet), roughly 3 of 13 by 2030 (~23%), and all 13 of 13 by 2040 (100% effect). Enrollment decline for year Y = (post-2022 cohorts / 13) &times; (average projected birth decline for those cohorts).</p>
      <p>The NCES / State Gvm't scenario does not use this model&mdash;it draws directly from published projections that already incorporate the full demographic picture.</p>
      <h3 style="margin-top:14px">School-Size Distribution</h3>
      <p>All closure calculations use the NCES 2022&ndash;23 school census filtered to traditional public schools (regular, operational, non-charter, non-virtual). Schools are grouped into five enrollment buckets, each assigned a representative average enrollment used in the closure model:</p>
      <p>&bull; Under 100 students &mdash; avg. 55<br>
         &bull; 100&ndash;199 &mdash; avg. 150<br>
         &bull; 200&ndash;299 &mdash; avg. 250<br>
         &bull; 300&ndash;499 &mdash; avg. 400<br>
         &bull; 500+ &mdash; avg. 750</p>
    </div>
    <div>
      <h3>Closure Probability Model</h3>
      <p>For each school-size bucket, the model projects a post-decline enrollment by multiplying the bucket's average enrollment by <em>(1 &minus; enrollment decline rate)</em>. That projected enrollment, combined with the magnitude of decline, determines an annual closure probability:</p>
      <p>&bull; Projected enrollment &lt;100 students: <strong>4%/year</strong> &mdash; very small schools face elevated closure risk from low enrollment regardless of cause.<br>
         &bull; Projected enrollment 100&ndash;199 <em>and</em> overall decline &gt;25%: <strong>3%/year</strong> &mdash; small schools facing steep decline.<br>
         &bull; Any school with overall decline &gt;10%: <strong>1.5%/year</strong> &mdash; schools under meaningful enrollment pressure.<br>
         &bull; All other schools: <strong>0.75%/year</strong> &mdash; background closure rate reflecting consolidations, facility issues, and other non-enrollment factors.</p>
      <p>Cumulative closure probability over time: <em>P(closure by year Y) = 1 &minus; (1 &minus; p<sub>annual</sub>)<sup>Y &minus; 2025</sup></em>. Expected closures for a bucket = school count &times; cumulative probability. All buckets are summed for the state total.</p>
      <p>These rates are calibrated against Brookings Institution (2024) historical closure data, which found annual closure rates below 0.5%/yr for most states and a maximum of 2.06%/yr (Washington D.C.) in the 2012&ndash;2024 period. The forward-looking rates used here are set above historical averages to reflect worsening enrollment conditions while remaining consistent with the range of observed state-level closure patterns.</p>
      <p>States projected to <em>gain</em> enrollment under any scenario are assigned zero expected closures&mdash;population growth implies net school openings, not closures.</p>
      <p>These probabilities are model estimates intended to be illustrative. Actual closure decisions depend on district fiscal capacity, state aid formulas, local politics, building conditions, and proximity to alternatives&mdash;none of which are captured here.</p>
    </div>
    <div>
      <h3>Data Sources</h3>
      <p>&bull; <strong>Fertility rates:</strong> CDC NCHS Vital Statistics 2022 (via USAFacts). State-level proxy: births per 1,000 women ages 15&ndash;44.</p>
      <p>&bull; <strong>Birth trajectory:</strong> Census Bureau 2023 National Population Projections, Table 2 (Under-5 population as national births proxy).</p>
      <p>&bull; <strong>School data:</strong> NCES Common Core of Data 2022&ndash;23. Filtered to regular, operational, non-charter, non-virtual traditional public schools.</p>
      <p>&bull; <strong>NCES enrollment projections:</strong> NCES Projections of Education Statistics to 2031 and to 2050, state-level tables.</p>
      <p>&bull; <strong>State agency projections:</strong> CA Dept of Finance; CO Dept of Local Affairs (DOLA) county age projections; IA Dept of Education; MD Dept of Planning; NC, FL, TX, VA, WI state enrollment forecasts.</p>
      <p>&bull; <strong>Boundaries:</strong> Census TIGER/Line 2022, 1:20m cartographic.</p>
    </div>
    <div class="full">
      <h3>Important Caveats</h3>
      <p>The <strong>State Fertility Trend</strong> scenario isolates the fertility channel only. It does not account for domestic or international migration, school consolidation decisions, charter school competition, private school trends, or changes in birth timing. It shows what would happen to enrollment if only fertility rates change as projected&mdash;a useful lower-bound estimate but not a complete forecast.</p>
      <p>The <strong>NCES / State Gvm't</strong> scenario incorporates richer demographic inputs but is only as good as the underlying agency projections, which vary in methodology, vintage, and local assumptions. Linear extrapolation beyond an agency's published horizon introduces additional uncertainty.</p>
      <p>Across all scenarios, the <strong>closure model is illustrative</strong>. Actual school closures depend on district fiscal capacity, state aid, local politics, charter competition, demographic concentration within districts, and decisions by school boards&mdash;none of which are captured here. This tool is intended to highlight which states face the most structural enrollment pressure, not to predict specific closures.</p>
    </div>
  </div>
</div>

<script>
const YEARS = [2025, 2027, 2030, 2033, 2035, 2037, 2040];
let stateData = null;
let stateGeo = null;
let geoLayer = null;
let map = null;

// Color scales
const SCALES = {
  enrollment_decline_pct: {
    label: 'Enrollment Decline',
    unit: '%',
    breaks: [0, 1, 5, 10, 15, 25],
    colors: ['#f7fcf5','#c7e9c0','#fdd49e','#fc8d59','#e34a33','#b30000'],
    labels: ['<1%','1-5%','5-10%','10-15%','15-25%','>25%']
  },
  enrollment_change_cc: {
    label: 'Enrollment Change',
    unit: '%',
    breaks: [-15, -10, -5, 0, 5, 10],
    colors: ['#005a32','#41ab5d','#c7e9c0','#fdd49e','#fc8d59','#b30000'],
    labels: ['>10% gain','5-10% gain','0-5% gain','0-5% decline','5-10% decline','>10% decline']
  },
  expected_closures: {
    label: 'Expected Closures',
    unit: '',
    breaks: [0, 50, 150, 300, 500, 1000],
    colors: ['#f7fcf5','#c7e9c0','#fdd49e','#fc8d59','#e34a33','#b30000'],
    labels: ['<50','50-150','150-300','300-500','500-1K','>1K']
  },
  expected_closures_pct: {
    label: 'Closure Risk',
    unit: '%',
    breaks: [0, 5, 10, 15, 20, 30],
    colors: ['#f7fcf5','#c7e9c0','#fdd49e','#fc8d59','#e34a33','#b30000'],
    labels: ['<5%','5-10%','10-15%','15-20%','20-30%','>30%']
  },
  fertility_rate: {
    label: 'Fertility Rate',
    unit: '',
    breaks: [35, 45, 50, 55, 60, 65],
    colors: ['#b30000','#e34a33','#fc8d59','#fdd49e','#c7e9c0','#f7fcf5'],
    labels: ['<45','45-50','50-55','55-60','60-65','>65']
  }
};

function getColor(value, metric) {
  const scale = SCALES[metric];
  const b = scale.breaks;
  const c = scale.colors;
  if (value >= b[5]) return c[5];
  if (value >= b[4]) return c[4];
  if (value >= b[3]) return c[3];
  if (value >= b[2]) return c[2];
  if (value >= b[1]) return c[1];
  return c[0];
}

function getState() {
  const scenario = document.querySelector('input[name="scenario"]:checked').value;
  const year = YEARS[parseInt(document.getElementById('yearSlider').value)];
  return { scenario, year, metric: document.getElementById('colorMetric').value };
}

function fmt(n, d) {
  if (n === undefined || n === null) return '--';
  if (d !== undefined) return n.toFixed(d);
  if (Math.abs(n) >= 1000) return n.toLocaleString('en-US', {maximumFractionDigits: 0});
  return n.toLocaleString('en-US', {maximumFractionDigits: 1});
}

function updateLegend(metric) {
  const scale = SCALES[metric];
  let html = '<div class="legend-title">' + scale.label + '</div>';
  for (let i = 0; i < scale.colors.length; i++) {
    html += '<div class="legend-item">' +
      '<div class="legend-color" style="background:' + scale.colors[i] + '"></div>' +
      '<span>' + scale.labels[i] + '</span></div>';
  }
  document.getElementById('legend').innerHTML = html;
}

function updateStats(scenario, year) {
  const scenarioLabels = {state_trend: 'State Fertility Trend', enrollment_proj: 'NCES / State Gvm\'t'};
  document.getElementById('statScenario').textContent = (scenarioLabels[scenario] || scenario) + ' ' + year;

  let totalDecline = 0, totalClosures = 0, totalEnrollment = 0, totalProjected = 0, count = 0;
  for (const abbr in stateData) {
    const d = stateData[abbr];
    const scenData = d.scenarios[scenario];
    if (!scenData) continue;
    const yr = scenData[String(year)];
    if (!yr) continue;
    totalDecline += yr.enrollment_decline_pct * d.current_enrollment;
    totalEnrollment += d.current_enrollment;
    totalProjected += yr.projected_enrollment;
    totalClosures += yr.expected_closures;
    count++;
  }

  const avgDecline = totalEnrollment > 0 ? totalDecline / totalEnrollment : 0;
  const studentsLost = totalEnrollment - totalProjected;

  document.getElementById('statDecline').textContent = avgDecline.toFixed(1) + '%';
  document.getElementById('statClosures').textContent = Math.round(totalClosures).toLocaleString();
  document.getElementById('statStudents').textContent = Math.round(studentsLost).toLocaleString();
}

function buildPopup(abbr, scenario, year) {
  const d = stateData[abbr];
  if (!d) return 'No data';
  const scenData = d.scenarios[scenario];
  if (!scenData) return 'No data for this scenario';
  const yr = scenData[String(year)];
  if (!yr) return 'No data for ' + year;

  const isEnrollProj = scenario === 'enrollment_proj';
  let html = '<div class="popup-title">' + d.state + ' (' + abbr + ')</div>';

  if (isEnrollProj) {
    const srcLabel = d.enrollment_proj_source === 'state' ? 'State Agency' : 'NCES';
    const lastNative = d.enrollment_proj_last_native_year || '?';
    const srcUrl = d.enrollment_proj_url || '';
    const srcLink = srcUrl ? '<a href="' + srcUrl + '" target="_blank" style="color:var(--accent);text-decoration:underline;">' + srcLabel + '</a>' : srcLabel;
    html += '<div style="font-size:10px;color:#888;font-style:italic;margin-bottom:6px;">Source: ' + srcLink + ' (native data through ' + lastNative + ')' + (yr.extrapolated ? ' &mdash; <span style="color:var(--orange)">extrapolated</span>' : '') + '</div>';
  }

  html += '<div class="popup-stat"><span class="plbl">Current Schools</span><span class="pval">' + fmt(d.current_schools) + '</span></div>';
  html += '<div class="popup-stat"><span class="plbl">Current Enrollment</span><span class="pval">' + fmt(d.current_enrollment) + '</span></div>';

  if (!isEnrollProj) {
    html += '<div class="popup-stat"><span class="plbl">Fertility Rate (2022)</span><span class="pval">' + d.rate_2022.toFixed(1) + '</span></div>';
    html += '<div class="popup-stat"><span class="plbl">2005-2022 Decline</span><span class="pval">' + (d.decline_2005_2022 * 100).toFixed(1) + '%</span></div>';
  }

  html += '<div style="margin-top:8px;padding-top:6px;border-top:2px solid #e94560">';
  if (!isEnrollProj) {
    html += '<div class="popup-stat"><span class="plbl">Projected Fertility (' + year + ')</span><span class="pval">' + yr.fertility_rate.toFixed(1) + '</span></div>';
    html += '<div class="popup-stat"><span class="plbl">Birth Decline</span><span class="pval" style="color:var(--red)">' + yr.birth_decline_pct.toFixed(1) + '%</span></div>';
    html += '<div class="popup-stat"><span class="plbl">Pipeline Fraction</span><span class="pval">' + (yr.post_2022_fraction * 100).toFixed(0) + '%</span></div>';
  }
  const declinePct = yr.enrollment_decline_pct;
  const declineColor = declinePct > 0 ? 'var(--red)' : 'var(--green)';
  const declineLabel = declinePct > 0 ? 'Enrollment Decline' : 'Enrollment Gain';
  html += '<div class="popup-stat"><span class="plbl">' + declineLabel + '</span><span class="pval" style="color:' + declineColor + '">' + Math.abs(declinePct).toFixed(1) + '%</span></div>';
  html += '<div class="popup-stat"><span class="plbl">Projected Enrollment</span><span class="pval">' + fmt(yr.projected_enrollment) + '</span></div>';
  html += '<div class="popup-stat"><span class="plbl">Expected Closures</span><span class="pval" style="color:var(--orange)">' + yr.expected_closures.toFixed(0) + ' (' + yr.expected_closures_pct.toFixed(1) + '%)</span></div>';
  html += '</div>';

  const trendYears = YEARS;
  html += '<div class="popup-trend"><table><tr><th>Year</th>';
  for (const y of trendYears) {
    html += '<th' + (y === year ? ' class="cur"' : '') + '>' + String(y).slice(2) + '</th>';
  }
  html += '</tr><tr><td style="font-weight:600">Decline</td>';
  for (const y of trendYears) {
    const yd = scenData[String(y)];
    const v = yd ? yd.enrollment_decline_pct.toFixed(1) : '--';
    const ext = (isEnrollProj && yd && yd.extrapolated) ? '*' : '';
    html += '<td' + (y === year ? ' class="cur"' : '') + '>' + v + '%' + ext + '</td>';
  }
  html += '</tr><tr><td style="font-weight:600">Closures</td>';
  for (const y of trendYears) {
    const yd = scenData[String(y)];
    const v = yd ? Math.round(yd.expected_closures) : '--';
    html += '<td' + (y === year ? ' class="cur"' : '') + '>' + v + '</td>';
  }
  html += '</tr></table></div>';

  return html;
}

function handleScenarioChange() {
  const scenario = document.querySelector('input[name="scenario"]:checked').value;
  const isTrend = scenario === 'state_trend';
  // Fertility Rate color metric only meaningful for State Fertility Trend
  const fertilityOpt = document.querySelector('#colorMetric option[value="fertility_rate"]');
  fertilityOpt.hidden = !isTrend;
  fertilityOpt.disabled = !isTrend;
  if (!isTrend && document.getElementById('colorMetric').value === 'fertility_rate') {
    document.getElementById('colorMetric').value = 'enrollment_decline_pct';
  }
  updateMap();
}

function updateMap() {
  if (!geoLayer || !stateData) return;
  const st = getState();
  document.getElementById('yearDisplay').textContent = st.year;

  const isEnrollProj = st.scenario === 'enrollment_proj';
  const effectiveMetric = (isEnrollProj && st.metric === 'enrollment_decline_pct') ? 'enrollment_change_cc' : st.metric;

  updateStats(st.scenario, st.year);
  updateLegend(effectiveMetric);

  geoLayer.eachLayer(function(layer) {
    const props = layer.feature.properties;
    const abbr = props.ABBR;
    const d = stateData[abbr];
    if (!d) {
      layer.setStyle({fillColor: '#ccc', fillOpacity: 0.3});
      return;
    }
    const scenData = d.scenarios[st.scenario];
    if (!scenData) {
      layer.setStyle({fillColor: '#ccc', fillOpacity: 0.3, weight: 1, color: '#999', opacity: 0.4});
      const noDataContent = '<strong>' + d.state + '</strong><br>No data for this scenario';
      if (layer.getTooltip()) { layer.getTooltip().setContent(noDataContent); }
      else { layer.bindTooltip(noDataContent, {className: 'state-tooltip', sticky: true}); }
      return;
    }
    const yr = scenData[String(st.year)];
    if (!yr) {
      layer.setStyle({fillColor: '#ccc', fillOpacity: 0.3, weight: 1, color: '#999', opacity: 0.4});
      return;
    }

    const value = yr[st.metric] || 0;
    const color = getColor(value, effectiveMetric);
    layer.setStyle({
      fillColor: color,
      fillOpacity: 0.75,
      weight: 1,
      color: '#666',
      opacity: 0.6
    });

    // Update tooltip â€” use setContent() if tooltip already exists so a
    // currently-visible sticky tooltip updates in place without flicker.
    const declinePctTip = yr.enrollment_decline_pct;
    const closuresTxt = Math.round(yr.expected_closures);
    const changeLabel = (isEnrollProj && declinePctTip < 0) ? 'Gain' : 'Decline';
    const changeTxt = (isEnrollProj && declinePctTip < 0)
      ? '+' + Math.abs(declinePctTip).toFixed(1)
      : declinePctTip.toFixed(1);
    const tooltipContent = '<strong>' + d.state + '</strong><br>' +
      changeLabel + ': ' + changeTxt + '% | Closures: ~' + closuresTxt;
    if (layer.getTooltip()) {
      layer.getTooltip().setContent(tooltipContent);
    } else {
      layer.bindTooltip(tooltipContent, {className: 'state-tooltip', sticky: true});
    }

    // Refresh popup content if it is currently open
    if (layer.isPopupOpen()) {
      layer.setPopupContent(buildPopup(abbr, st.scenario, st.year));
    }
  });
}

async function init() {
  try {
    const [projRes, geoRes] = await Promise.all([
      fetch('state_projections.json'),
      fetch('states.json')
    ]);
    stateData = await projRes.json();
    stateGeo = await geoRes.json();
  } catch(e) {
    document.getElementById('loading').innerHTML = '<div style="color:red;font-size:16px">Error loading data: ' + e.message + '</div>';
    return;
  }

  map = L.map('map', {zoomSnap: 0.25}).setView([39, -96], 4);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    maxZoom: 12
  }).addTo(map);

  // Add labels on top
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
    maxZoom: 12, pane: 'overlayPane'
  }).addTo(map);

  geoLayer = L.geoJSON(stateGeo, {
    style: {
      fillColor: '#ccc',
      fillOpacity: 0.3,
      weight: 1,
      color: '#666',
      opacity: 0.6
    },
    onEachFeature: function(feature, layer) {
      layer.on({
        click: function() {
          const st = getState();
          const popup = buildPopup(feature.properties.ABBR, st.scenario, st.year);
          layer.bindPopup(popup, {maxWidth: 360}).openPopup();
        },
        mouseover: function(e) {
          e.target.setStyle({weight: 2.5, color: '#333', opacity: 1});
          e.target.bringToFront();
        },
        mouseout: function(e) {
          geoLayer.resetStyle(e.target);
          updateMap();
        }
      });
    }
  }).addTo(map);

  // Event listeners
  document.getElementById('yearSlider').addEventListener('input', updateMap);
  document.querySelectorAll('input[name="scenario"]').forEach(function(r) {
    r.addEventListener('change', handleScenarioChange);
  });
  document.getElementById('colorMetric').addEventListener('change', updateMap);

  document.getElementById('methToggle').addEventListener('click', function() {
    const m = document.getElementById('methodology');
    m.classList.toggle('open');
    this.innerHTML = m.classList.contains('open')
      ? 'Methodology &amp; Sources &#9650;'
      : 'Methodology &amp; Sources &#9660;';
  });

  updateMap();
  document.getElementById('loading').classList.add('hidden');
}

init();
</script>
</body>
</html>
